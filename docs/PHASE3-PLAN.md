# План разработки: Фаза 3

Этот документ содержит детальный план третьей фазы разработки aprover.

## Обзор Фазы 3

Фаза 3 направлена на расширение функциональности прувера: поддержка файловых операций, дополнительных нотаций МТС и улучшение алгоритма резолюции.

## Этап 3.1: Файловые операции — Завершено ✅

- [x] Загрузка файлов `.mtl` (формальная нотация)
- [x] Сохранение результатов в файл
- [x] История последних файлов в localStorage
- [x] Drag-and-drop загрузка файлов

**Критерии успеха:**
- ✅ Пользователь может загрузить файл `.mtl` через кнопку или drag-and-drop
- ✅ Результаты верификации можно сохранить в файл (текст и JSON)
- ✅ Сохраняется история последних 10 файлов

**Дополнительно реализовано:**
- Панель инструментов с кнопками: Новый, Открыть, Недавние, Сохранить, Результаты, JSON
- Клавиатурные сокращения: Ctrl+N, Ctrl+O, Ctrl+S
- Автосохранение в localStorage каждые 30 секунд
- Экспорт результатов в формате JSON
- Визуальная обратная связь при drag-and-drop

## Этап 3.2: Поддержка строковых ачисел (.astr)

- [ ] Парсер строковых ачисел (UTF-8)
- [ ] Конвертация строковых ачисел в формальную нотацию
- [ ] Визуализация процесса конвертации
- [ ] Загрузка/сохранение файлов `.astr`

**Критерии успеха:**
- Парсер корректно обрабатывает UTF-8 строки
- Показан процесс преобразования: строка → цепочка формальных запросов

## Этап 3.3: Поддержка четверичной нотации (.anum)

- [ ] Парсер абитовой (четверичной) нотации
- [ ] Обработка вложенных контекстов `[ ... ]`
- [ ] Конвертация в строковые ачисла и формальную нотацию
- [ ] Загрузка/сохранение файлов `.anum`

**Критерии успеха:**
- Парсер корректно обрабатывает алфавит `0, 1, [, ]`
- Поддержаны вложенные контексты
- Полный цикл: `.anum` → `.astr` → формальная нотация

## Этап 3.4: Расширение алгоритма резолюции

- [ ] Реализация Modus Ponens для цепочек: если P и (P → Q), то Q
- [ ] Транзитивность равенства: {(x = y), (y = z)} → (x = z)
- [ ] Симметрия равенства: (x = y) → (y = x)
- [ ] Конгруэнция для связей: {(a = c), (b = d)} → ((a → b) = (c → d))

**Критерии успеха:**
- Прувер автоматически применяет цепочки выводов
- Поддержаны все свойства отношения равенства

## Этап 3.5: Улучшение производительности и UX

- [x] Keyboard shortcuts (Ctrl+O, Ctrl+S, Ctrl+N для файлов)
- [x] Автосохранение в localStorage
- [ ] Кэширование результатов нормализации
- [ ] Ленивая загрузка узлов AST для больших выражений

**Критерии успеха:**
- Быстрая работа на выражениях до 1000 узлов AST
- ✅ Удобное управление с клавиатуры
- ✅ Данные не теряются при обновлении страницы (автосохранение)

## Этап 3.6: Тестирование и документация

- [ ] Unit-тесты для новых парсеров (.astr, .anum)
- [ ] Unit-тесты для расширенного алгоритма резолюции
- [x] E2E тесты для файловых операций (15 новых тестов)
- [x] Unit-тесты для fileIO модуля (34 новых теста)
- [x] Обновление документации пользователя

**Критерии успеха:**
- ✅ Покрытие тестами новых функций (файловые операции)
- ✅ Все существующие тесты проходят
- ✅ Документация отражает новые возможности

---

## Ход работ

### 2026-02-13: Начало Фазы 3

**Планирование** — Завершено
- Создан план третьей фазы разработки
- Определены приоритеты этапов
- Подготовлена структура задач

**Этап 3.1: Файловые операции** — Завершено ✅
- Создан модуль `src/core/fileIO.ts` для файловых операций
- Реализована загрузка файлов `.mtl` через кнопку "Открыть" и drag-and-drop
- Реализовано сохранение кода и результатов в файлы
- Добавлен экспорт результатов в формате JSON
- Добавлена история последних файлов (до 10 файлов) в localStorage
- Добавлено автосохранение каждые 30 секунд
- Добавлены клавиатурные сокращения: Ctrl+N (новый), Ctrl+O (открыть), Ctrl+S (сохранить)
- Добавлена панель инструментов с кнопками файловых операций
- Добавлены 34 unit-теста для fileIO модуля
- Добавлены 15 E2E тестов для файловых операций
- **Итого тестов:** 242 (186 unit/интеграционных + 56 E2E)

---

## Связь с предыдущими фазами

Фаза 3 строится на основе полностью завершённых Фазы 1 и Фазы 2:

### Фаза 1 (завершена):
- ✅ Лексер формальной нотации
- ✅ Парсер формальной нотации
- ✅ Нормализатор
- ✅ Ядро прувера
- ✅ Базовый веб-интерфейс
- ✅ 151 тест (104 unit + 33 интеграционных + 17 E2E)

### Фаза 2 (завершена):
- ✅ Компонентная архитектура UI
- ✅ Подсветка синтаксиса
- ✅ Визуализация AST с интерактивной подсветкой
- ✅ Улучшение прувера (пошаговый вывод, аксиомы, подсказки)
- ✅ Тестирование и документация
- ✅ 193 теста (152 unit/интеграционных + 41 E2E)

---

## Архитектурные решения Фазы 3

### Структура парсеров трёх нотаций

```
┌─────────────────────────────────────────────────────┐
│  Файловый ввод                                      │
│  • .mtl (формальная нотация)                        │
│  • .astr (строковые ачисла)                         │
│  • .anum (четверичные ачисла)                       │
└───────────────┬─────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────────────────┐
│  Маршрутизатор по расширению файла                  │
│  • .mtl  → formalParser                             │
│  • .astr → stringAnumParser → formalParser          │
│  • .anum → quatParser → stringAnumParser → formal   │
└───────────────┬─────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────────────────┐
│  Единый AST (формальная нотация)                    │
│  → Нормализация                                     │
│  → Верификация                                      │
└─────────────────────────────────────────────────────┘
```

### Новые модули

```
src/core/
├── lexer.ts          # (существует) Лексер формальной нотации
├── parser.ts         # (существует) Парсер формальной нотации
├── fileIO.ts         # (новый, реализован) Файловые операции
├── stringAnum.ts     # (планируется) Парсер строковых ачисел
└── quatAnum.ts       # (планируется) Парсер четверичной нотации
```

### Реализованные функции fileIO.ts

- `readFileContent(file)` — чтение содержимого файла
- `isSupportedFile(filename)` — проверка поддерживаемого расширения
- `getFilePreview(content)` — получение превью для списка недавних
- `getRecentFiles()` / `addRecentFile()` / `removeRecentFile()` — история файлов
- `saveAutosave()` / `loadAutosave()` — автосохранение
- `formatResultsForExport(results, options)` — форматирование результатов
- `downloadFile(content, filename)` — скачивание файла
- `openFileDialog(accept)` — диалог выбора файла
